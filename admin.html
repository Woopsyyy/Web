<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brewlen's Cafe - Admin Panel</title>
    <link href="Bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            padding-top: 80px;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .admin-header {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .menu-item-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .menu-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .menu-item-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
        }
        .form-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 2rem;
            border: 1px solid #e9ecef;
        }
        .btn-action {
            margin: 0 0.25rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .btn-action:hover {
            transform: scale(1.05);
        }
                 .category-badge {
             font-size: 0.8rem;
             padding: 0.5rem 1rem;
             border-radius: 20px;
             background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
             color: white;
             font-weight: 500;
         }
        .btn-cafe {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            border: none;
            color: white;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .btn-cafe:hover {
            background: linear-gradient(135deg, #A0522D 0%, #8B4513 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
        }
        .btn-cafe-outline {
            border: 2px solid #8B4513;
            color: #8B4513;
            background: transparent;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .btn-cafe-outline:hover {
            background: #8B4513;
            color: white;
            transform: translateY(-2px);
        }
        .search-filter-container {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #8B4513;
            box-shadow: 0 0 0 0.2rem rgba(139, 69, 19, 0.25);
        }
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        .alert {
            border-radius: 10px;
            border: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="Images/cafe logo.jpg" alt="Brewlen's Cafe" class="navbar-img me-2" style="width: 30px; height: 30px; object-fit: cover;">
                Admin Panel
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="menu.html">
                    <i class="fas fa-utensils me-1"></i>View Menu
                </a>
                <a class="nav-link" href="index.html">
                    <i class="fas fa-home me-1"></i>Home
                </a>
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <!-- Admin Header -->
        <div class="admin-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="mb-2">
                            <i class="fas fa-cog me-2"></i>Menu Management
                        </h1>
                        <p class="mb-0">Add, edit, and delete menu items for your cafe</p>
                    </div>
                                         <div class="col-md-4 text-end">
                         <button class="btn btn-cafe btn-lg me-2" onclick="showAddForm()">
                             <i class="fas fa-plus me-2"></i>Add New Item
                         </button>
                         <button class="btn btn-cafe-outline btn-lg" onclick="checkDuplicates()">
                             <i class="fas fa-exclamation-triangle me-2"></i>Check Duplicates
                         </button>
                     </div>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Alert Messages -->
            <div id="alertContainer"></div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu-content" type="button" role="tab">
                        <i class="fas fa-utensils me-2"></i>Menu Management
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback-content" type="button" role="tab">
                        <i class="fas fa-comments me-2"></i>Customer Feedback
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-content" type="button" role="tab">
                        <i class="fas fa-users me-2"></i>User Management
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="adminTabContent">
                <!-- Menu Management Tab -->
                <div class="tab-pane fade show active" id="menu-content" role="tabpanel">

                         <!-- Add Modal -->
             <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
                 <div class="modal-dialog modal-xl">
                     <div class="modal-content">
                         <div class="modal-header">
                             <h5 class="modal-title" id="addModalLabel">Add New Menu Item</h5>
                             <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                         </div>
                         <div class="modal-body">
                             <form id="addForm">
                                 <div class="row">
                                     <div class="col-md-6">
                                         <div class="mb-3">
                                             <label for="addTitle" class="form-label">Title *</label>
                                             <input type="text" class="form-control" id="addTitle" required>
                                         </div>
                                     </div>
                                     <div class="col-md-6">
                                         <div class="mb-3">
                                             <label for="addCategory" class="form-label">Category *</label>
                                             <select class="form-select" id="addCategory" required>
                                                 <option value="">Select Category</option>
                                                 <option value="main">Main Dishes</option>
                                                 <option value="appetizer">Appetizers</option>
                                                 <option value="dessert">Desserts</option>
                                                 <option value="beverage">Beverages</option>
                                             </select>
                                         </div>
                                     </div>
                                 </div>

                                 <div class="mb-3">
                                     <label for="addDescription" class="form-label">Description *</label>
                                     <textarea class="form-control" id="addDescription" rows="3" required></textarea>
                                 </div>

                                 <div class="row">
                                     <div class="col-md-6">
                                         <div class="mb-3">
                                             <label for="addImage" class="form-label">Image Path *</label>
                                             <input type="text" class="form-control" id="addImage" placeholder="Images/filename.jpg" required>
                                         </div>
                                     </div>
                                     <div class="col-md-6">
                                         <div class="mb-3">
                                             <label for="addPrice" class="form-label">Price *</label>
                                             <input type="text" class="form-control" id="addPrice" placeholder="$12.99" required>
                                         </div>
                                     </div>
                                 </div>

                                 <div class="mb-3">
                                     <label for="addIngredients" class="form-label">Ingredients *</label>
                                     <textarea class="form-control" id="addIngredients" rows="2" required></textarea>
                                 </div>

                                 <div class="row">
                                     <div class="col-md-6">
                                         <div class="mb-3">
                                             <label for="addPrepTime" class="form-label">Preparation Time *</label>
                                             <input type="text" class="form-control" id="addPrepTime" placeholder="25-30 minutes" required>
                                         </div>
                                     </div>
                                     <div class="col-md-6">
                                         <div class="mb-3">
                                             <label for="addTags" class="form-label">Tags (comma-separated)</label>
                                             <input type="text" class="form-control" id="addTags" placeholder="chicken,spicy,curry">
                                             <small class="form-text text-muted">Example: chicken,spicy,curry (for better search and filtering)</small>
                                         </div>
                                     </div>
                                 </div>
                             </form>
                         </div>
                         <div class="modal-footer">
                             <button type="button" class="btn btn-cafe-outline" data-bs-dismiss="modal">Cancel</button>
                             <button type="button" class="btn btn-cafe" onclick="saveAdd()">Save Item</button>
                         </div>
                     </div>
                 </div>
             </div>

            <!-- Edit Modal -->
            <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editModalLabel">Edit Menu Item</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editForm">
                                <input type="hidden" id="editItemId">
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editTitle" class="form-label">Title *</label>
                                            <input type="text" class="form-control" id="editTitle" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editCategory" class="form-label">Category *</label>
                                            <select class="form-select" id="editCategory" required>
                                                <option value="">Select Category</option>
                                                <option value="main">Main Dishes</option>
                                                <option value="appetizer">Appetizers</option>
                                                <option value="dessert">Desserts</option>
                                                <option value="beverage">Beverages</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="editDescription" class="form-label">Description *</label>
                                    <textarea class="form-control" id="editDescription" rows="3" required></textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editImage" class="form-label">Image Path *</label>
                                            <input type="text" class="form-control" id="editImage" placeholder="Images/filename.jpg" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editPrice" class="form-label">Price *</label>
                                            <input type="text" class="form-control" id="editPrice" placeholder="$12.99" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="editIngredients" class="form-label">Ingredients *</label>
                                    <textarea class="form-control" id="editIngredients" rows="2" required></textarea>
                                </div>

                                                                 <div class="row">
                                     <div class="col-md-6">
                                         <div class="mb-3">
                                             <label for="editPrepTime" class="form-label">Preparation Time *</label>
                                             <input type="text" class="form-control" id="editPrepTime" placeholder="25-30 minutes" required>
                                         </div>
                                     </div>
                                     <div class="col-md-6">
                                         <div class="mb-3">
                                             <label for="editTags" class="form-label">Tags (comma-separated)</label>
                                             <input type="text" class="form-control" id="editTags" placeholder="chicken,spicy,curry">
                                             <small class="form-text text-muted">Example: chicken,spicy,curry (for better search and filtering)</small>
                                         </div>
                                     </div>
                                 </div>
                            </form>
                        </div>
                                                 <div class="modal-footer">
                             <button type="button" class="btn btn-cafe-outline" data-bs-dismiss="modal">Cancel</button>
                             <button type="button" class="btn btn-cafe" onclick="saveEdit()">Save Changes</button>
                         </div>
                    </div>
                </div>
            </div>

                         <!-- Menu Items List -->
             <div class="row">
                 <div class="col-12">
                     <div class="search-filter-container">
                         <div class="d-flex justify-content-between align-items-center">
                             <h4 class="mb-0">Current Menu Items</h4>
                             <div class="d-flex gap-2">
                                 <input type="text" class="form-control" id="searchInput" placeholder="Search items..." style="width: 250px;">
                                 <select class="form-select" id="categoryFilter" style="width: 150px;">
                                     <option value="">All Categories</option>
                                     <option value="main">Main Dishes</option>
                                     <option value="appetizer">Appetizers</option>
                                     <option value="dessert">Desserts</option>
                                     <option value="beverage">Beverages</option>
                                 </select>
                             </div>
                         </div>
                     </div>
                    
                    <div id="menuItemsList">
                        <!-- Menu items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

                <!-- Feedback Management Tab -->
                <div class="tab-pane fade" id="feedback-content" role="tabpanel">
                    <div class="search-filter-container">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0">
                                    <i class="fas fa-comments me-2"></i>Customer Feedback & Ratings
                                </h5>
                                <p class="text-muted mb-0">View and manage customer feedback submissions</p>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-cafe" onclick="loadFeedback()">
                                    <i class="fas fa-sync-alt me-2"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="feedbackList">
                        <!-- Feedback items will be loaded here -->
                    </div>
                </div>

                <!-- User Management Tab -->
                <div class="tab-pane fade" id="users-content" role="tabpanel">
                    <div class="search-filter-container">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2"></i>User Management
                                </h5>
                                <p class="text-muted mb-0">Manage user accounts and admin privileges</p>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-cafe" onclick="loadUsers()">
                                    <i class="fas fa-sync-alt me-2"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="usersList">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="Bootstrap/bootstrap.bundle.min.js"></script>
    
    <script>
        let menuItems = [];
        let isEditing = false;

        // Check admin authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadMenuItems();
            setupEventListeners();
        });

        // Check if user is admin
        async function checkAdminAuth() {
            try {
                const response = await fetch('Backend/admin/admin_check.php');
                const result = await response.json();
                
                if (!result.success) {
                    showAlert('Access denied. Admin privileges required.', 'danger');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showAlert('Authentication error. Please log in again.', 'danger');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }

        // Load menu items
        async function loadMenuItems() {
            try {
                const response = await fetch('Backend/admin/admin_menu.php');
                const result = await response.json();
                
                if (result.success) {
                    menuItems = result.dishes;
                    renderMenuItems();
                } else {
                    showAlert('Failed to load menu items: ' + result.error, 'danger');
                }
            } catch (error) {
                console.error('Error loading menu items:', error);
                showAlert('Failed to load menu items. Please try again.', 'danger');
            }
        }

        // Render menu items
        function renderMenuItems() {
            const container = document.getElementById('menuItemsList');
            
            if (menuItems.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No menu items found.</p>';
                return;
            }
            
            container.innerHTML = menuItems.map(item => `
                <div class="menu-item-card">
                    <div class="row align-items-center p-3">
                        <div class="col-md-2">
                            <img src="${item.image}" alt="${item.title}" class="menu-item-image rounded">
                        </div>
                        <div class="col-md-4">
                            <h5 class="mb-1">${item.title}</h5>
                            <p class="text-muted mb-1">${item.description.substring(0, 100)}${item.description.length > 100 ? '...' : ''}</p>
                            <span class="badge bg-primary category-badge">${item.category}</span>
                            ${item.tags ? `<div class="mt-1"><small class="text-muted">Tags: ${item.tags}</small></div>` : ''}
                        </div>
                        <div class="col-md-2">
                            <strong class="text-success">${item.price}</strong>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">${item.prep_time}</small>
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-sm btn-outline-primary btn-action" onclick="editItem(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteItem(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

                 // Show add form
         function showAddForm() {
             // Reset form
             document.getElementById('addForm').reset();
             
             // Show modal
             const modal = new bootstrap.Modal(document.getElementById('addModal'));
             modal.show();
         }

                           // Edit item
          function editItem(id) {
              const item = menuItems.find(item => item.id == id);
              if (!item) return;

              // Populate modal form
              document.getElementById('editItemId').value = item.id;
              document.getElementById('editTitle').value = item.title;
              document.getElementById('editDescription').value = item.description;
              document.getElementById('editImage').value = item.image;
              document.getElementById('editCategory').value = item.category;
              document.getElementById('editPrice').value = item.price;
              document.getElementById('editIngredients').value = item.ingredients;
              document.getElementById('editPrepTime').value = item.prep_time;
              document.getElementById('editTags').value = item.tags || '';

              // Show modal
              const modal = new bootstrap.Modal(document.getElementById('editModal'));
              modal.show();
          }

        // Delete item
        async function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this menu item?')) {
                return;
            }

            try {
                const response = await fetch(`Backend/admin/admin_menu.php?id=${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    showAlert('Menu item deleted successfully!', 'success');
                    loadMenuItems();
                } else {
                    showAlert('Failed to delete item: ' + result.error, 'danger');
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showAlert('Failed to delete item. Please try again.', 'danger');
            }
        }

                 // Setup event listeners
         function setupEventListeners() {
             // Search functionality
             document.getElementById('searchInput').addEventListener('input', filterItems);
             document.getElementById('categoryFilter').addEventListener('change', filterItems);
         }

                 // Save add function
         async function saveAdd() {
             const formData = {
                 title: document.getElementById('addTitle').value,
                 description: document.getElementById('addDescription').value,
                 image: document.getElementById('addImage').value,
                 category: document.getElementById('addCategory').value,
                 price: document.getElementById('addPrice').value,
                 ingredients: document.getElementById('addIngredients').value,
                 prep_time: document.getElementById('addPrepTime').value,
                 tags: document.getElementById('addTags').value
             };

             try {
                 const response = await fetch('Backend/admin/admin_menu.php', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify(formData)
                 });

                 const result = await response.json();

                 if (result.success) {
                     showAlert('Menu item created successfully!', 'success');
                     // Hide modal
                     const modal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
                     modal.hide();
                     loadMenuItems();
                 } else {
                     showAlert('Failed to save item: ' + result.error, 'danger');
                 }
             } catch (error) {
                 console.error('Error saving item:', error);
                 showAlert('Failed to save item. Please try again.', 'danger');
             }
         }

                 // Save edit function
         async function saveEdit() {
             const formData = {
                 id: document.getElementById('editItemId').value,
                 title: document.getElementById('editTitle').value,
                 description: document.getElementById('editDescription').value,
                 image: document.getElementById('editImage').value,
                 category: document.getElementById('editCategory').value,
                 price: document.getElementById('editPrice').value,
                 ingredients: document.getElementById('editIngredients').value,
                 prep_time: document.getElementById('editPrepTime').value,
                 tags: document.getElementById('editTags').value
             };

            try {
                const response = await fetch('Backend/admin/admin_menu.php', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Menu item updated successfully!', 'success');
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                    modal.hide();
                    loadMenuItems();
                } else {
                    showAlert('Failed to update item: ' + result.error, 'danger');
                }
            } catch (error) {
                console.error('Error updating item:', error);
                showAlert('Failed to update item. Please try again.', 'danger');
            }
        }

        // Filter items
        function filterItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            const filteredItems = menuItems.filter(item => {
                const matchesSearch = item.title.toLowerCase().includes(searchTerm) || 
                                    item.description.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            renderFilteredItems(filteredItems);
        }

        // Render filtered items
        function renderFilteredItems(items) {
            const container = document.getElementById('menuItemsList');
            
            if (items.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No items match your search criteria.</p>';
                return;
            }
            
                         container.innerHTML = items.map(item => `
                 <div class="menu-item-card">
                     <div class="row align-items-center p-3">
                         <div class="col-md-2">
                             <img src="${item.image}" alt="${item.title}" class="menu-item-image rounded">
                         </div>
                         <div class="col-md-4">
                             <h5 class="mb-1">${item.title}</h5>
                             <p class="text-muted mb-1">${item.description.substring(0, 100)}${item.description.length > 100 ? '...' : ''}</p>
                             <span class="badge bg-primary category-badge">${item.category}</span>
                             ${item.tags ? `<div class="mt-1"><small class="text-muted">Tags: ${item.tags}</small></div>` : ''}
                         </div>
                        <div class="col-md-2">
                            <strong class="text-success">${item.price}</strong>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">${item.prep_time}</small>
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-sm btn-outline-primary btn-action" onclick="editItem(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteItem(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show alert
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            alertContainer.innerHTML = alertHtml;
        }

                 // Check for duplicates
         async function checkDuplicates() {
           try {
             const response = await fetch('Backend/utils/check_duplicates.php');
             const result = await response.json();
             
             if (result.success) {
               if (result.duplicates.length > 0) {
                 const duplicateList = result.duplicates.map(d => 
                   `${d.title} (${d.count} copies - IDs: ${d.ids})`
                 ).join('\n');
                 
                 const shouldCleanup = confirm(
                   `Found ${result.duplicates.length} duplicate items:\n\n${duplicateList}\n\nWould you like to remove the duplicates? (This will keep the first occurrence of each item)`
                 );
                 
                 if (shouldCleanup) {
                   await cleanupDuplicates();
                 }
               } else {
                 showAlert('No duplicates found! Your menu is clean.', 'success');
               }
             } else {
               showAlert('Failed to check duplicates: ' + result.error, 'danger');
             }
           } catch (error) {
             console.error('Error checking duplicates:', error);
             showAlert('Failed to check duplicates. Please try again.', 'danger');
           }
         }
         
         // Cleanup duplicates
         async function cleanupDuplicates() {
           try {
             const response = await fetch('Backend/utils/cleanup_duplicates.php');
             const result = await response.json();
             
             if (result.success) {
               showAlert(`Cleanup completed! Removed ${result.removed_count} duplicate items.`, 'success');
               loadMenuItems(); // Reload the menu items
             } else {
               showAlert('Failed to cleanup duplicates: ' + result.error, 'danger');
             }
           } catch (error) {
             console.error('Error cleaning up duplicates:', error);
             showAlert('Failed to cleanup duplicates. Please try again.', 'danger');
           }
         }
         
                 // Logout function
        async function logout() {
          try {
            const response = await fetch('Backend/auth/auth_logout.php', {
              method: 'POST'
            });
            
            const result = await response.json();
            // Clear any cached data and redirect immediately
            localStorage.removeItem('user');
            sessionStorage.clear();
            window.location.replace('login.html');
          } catch (error) {
            console.error('Logout error:', error);
            // Clear any cached data and redirect even on error
            localStorage.removeItem('user');
            sessionStorage.clear();
            window.location.replace('login.html');
          }
        }

        // Feedback Management Functions
        async function loadFeedback() {
          try {
            const response = await fetch('Backend/admin/admin_feedback.php');
            const result = await response.json();
            
            if (result.success) {
              renderFeedback(result.feedback);
            } else {
              showAlert('Failed to load feedback: ' + result.error, 'danger');
            }
          } catch (error) {
            console.error('Error loading feedback:', error);
            showAlert('Failed to load feedback. Please try again.', 'danger');
          }
        }

        function renderFeedback(feedbackItems) {
          const container = document.getElementById('feedbackList');
          
          if (feedbackItems.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No feedback submissions found.</p>';
            return;
          }
          
          container.innerHTML = feedbackItems.map(item => {
            const typeBadge = item.type === 'rating' ? 
              '<span class="badge bg-warning text-dark">Rating</span>' : 
              '<span class="badge bg-info">Feedback</span>';
            
            const ratingStars = item.type === 'rating' && item.rating ? 
              '<div class="mt-2">' + '★'.repeat(item.rating) + '☆'.repeat(5 - item.rating) + '</div>' : '';
            
            const date = new Date(item.created_at).toLocaleDateString() + ' ' + 
                        new Date(item.created_at).toLocaleTimeString();
            
            return `
              <div class="menu-item-card">
                <div class="row align-items-center p-3">
                  <div class="col-md-2">
                    <div class="text-center">
                      <i class="fas fa-user-circle" style="font-size: 3rem; color: #8B4513;"></i>
                      <div class="mt-1">
                        <small class="text-muted">${item.user_name}</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <h6 class="mb-1">${item.type === 'rating' ? 'Rating Submission' : 'Feedback Message'}</h6>
                    ${typeBadge}
                    ${ratingStars}
                  </div>
                  <div class="col-md-4">
                    <p class="mb-1">${item.message || 'No additional comments'}</p>
                    <small class="text-muted">Submitted on ${date}</small>
                  </div>
                  <div class="col-md-3 text-end">
                    <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteFeedback(${item.id})">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }

        async function deleteFeedback(id) {
          if (!confirm('Are you sure you want to delete this feedback submission?')) {
            return;
          }

          try {
            const response = await fetch(`Backend/admin/admin_feedback.php?id=${id}`, {
              method: 'DELETE'
            });
            const result = await response.json();

            if (result.success) {
              showAlert('Feedback deleted successfully!', 'success');
              loadFeedback();
            } else {
              showAlert('Failed to delete feedback: ' + result.error, 'danger');
            }
          } catch (error) {
            console.error('Error deleting feedback:', error);
            showAlert('Failed to delete feedback. Please try again.', 'danger');
          }
        }

        // User Management Functions
        async function loadUsers() {
          try {
            const response = await fetch('Backend/admin/admin_users.php');
            const result = await response.json();
            
            if (result.success) {
              renderUsers(result.users);
            } else {
              showAlert('Failed to load users: ' + result.error, 'danger');
            }
          } catch (error) {
            console.error('Error loading users:', error);
            showAlert('Failed to load users. Please try again.', 'danger');
          }
        }

        function renderUsers(users) {
          const container = document.getElementById('usersList');
          
          if (users.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No users found.</p>';
            return;
          }
          
          container.innerHTML = users.map(user => {
            const roleBadge = user.role === 'admin' ? 
              '<span class="badge bg-danger">Admin</span>' : 
              '<span class="badge bg-secondary">User</span>';
            
            const date = new Date(user.created_at).toLocaleDateString();
            
            return `
              <div class="menu-item-card">
                <div class="row align-items-center p-3">
                  <div class="col-md-2">
                    <div class="text-center">
                      <i class="fas fa-user-circle" style="font-size: 3rem; color: #8B4513;"></i>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <h6 class="mb-1">${user.name}</h6>
                    <p class="text-muted mb-1">@${user.username}</p>
                    ${roleBadge}
                  </div>
                  <div class="col-md-3">
                    <p class="mb-1">${user.email}</p>
                    <small class="text-muted">Joined: ${date}</small>
                  </div>
                  <div class="col-md-4 text-end">
                    ${user.role === 'user' ? 
                      `<button class="btn btn-sm btn-outline-success btn-action" onclick="promoteToAdmin(${user.id})">
                        <i class="fas fa-crown"></i> Make Admin
                      </button>` : 
                      `<button class="btn btn-sm btn-outline-warning btn-action" onclick="demoteToUser(${user.id})">
                        <i class="fas fa-user"></i> Remove Admin
                      </button>`
                    }
                    <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteUser(${user.id})">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }

        async function promoteToAdmin(userId) {
          if (!confirm('Are you sure you want to promote this user to admin?')) {
            return;
          }

          try {
            const response = await fetch('Backend/admin/admin_users.php', {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                user_id: userId,
                role: 'admin'
              })
            });
            const result = await response.json();

            if (result.success) {
              showAlert('User promoted to admin successfully!', 'success');
              loadUsers();
            } else {
              showAlert('Failed to promote user: ' + result.error, 'danger');
            }
          } catch (error) {
            console.error('Error promoting user:', error);
            showAlert('Failed to promote user. Please try again.', 'danger');
          }
        }

        async function demoteToUser(userId) {
          if (!confirm('Are you sure you want to remove admin privileges from this user?')) {
            return;
          }

          try {
            const response = await fetch('Backend/admin/admin_users.php', {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                user_id: userId,
                role: 'user'
              })
            });
            const result = await response.json();

            if (result.success) {
              showAlert('Admin privileges removed successfully!', 'success');
              loadUsers();
            } else {
              showAlert('Failed to remove admin privileges: ' + result.error, 'danger');
            }
          } catch (error) {
            console.error('Error removing admin privileges:', error);
            showAlert('Failed to remove admin privileges. Please try again.', 'danger');
          }
        }

        async function deleteUser(userId) {
          if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            return;
          }

          try {
            const response = await fetch(`Backend/admin/admin_users.php?id=${userId}`, {
              method: 'DELETE'
            });
            const result = await response.json();

            if (result.success) {
              showAlert('User deleted successfully!', 'success');
              loadUsers();
            } else {
              showAlert('Failed to delete user: ' + result.error, 'danger');
            }
          } catch (error) {
            console.error('Error deleting user:', error);
            showAlert('Failed to delete user. Please try again.', 'danger');
          }
        }
    </script>
</body>
</html>
